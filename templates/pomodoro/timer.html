{% extends 'base.html' %}

{% load math_filters %}

{% block title %}Pomodoro Timer{% endblock %}

{% block content %}
<div class="pomodoro-container">
    <div class="pomodoro-header">
        <h1>‚è±Ô∏è Focus Timer</h1>
        <p>Time doesn't rush here. Stay focused.</p>
    </div>
    
    <div class="timer-main">
        <div class="timer-display">
            <div class="timer-ring">
                <svg viewBox="0 0 200 200">
                    <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(99, 102, 241, 0.1)" stroke-width="8"/>
                    <circle id="progress-ring" cx="100" cy="100" r="90" fill="none" stroke="url(#gradient)" stroke-width="8" 
                            stroke-linecap="round" transform="rotate(-90 100 100)" 
                            stroke-dasharray="565.48" stroke-dashoffset="0"/>
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            
            <div class="timer-content">
                <div id="time-display" class="time">25:00</div>
                <div id="session-label" class="session-type">Focus Time</div>
            </div>
        </div>
        
        <div class="timer-controls">
            <button id="start-btn" class="control-btn primary" onclick="startTimer()">
                <span class="btn-icon">‚ñ∂</span>
                <span>Start</span>
            </button>
            <button id="pause-btn" class="control-btn" onclick="pauseTimer()" style="display: none;">
                <span class="btn-icon">‚è∏</span>
                <span>Pause</span>
            </button>
            <button id="reset-btn" class="control-btn secondary" onclick="resetTimer()">
                <span class="btn-icon">‚Üª</span>
                <span>Reset</span>
            </button>
        </div>
        
        <div class="session-selector">
            <button class="session-btn active" data-duration="25" data-type="focus" onclick="selectSession(this)">
                <span class="session-icon">üéØ</span>
                <span>Focus</span>
                <span class="session-time">25 min</span>
            </button>
            <button class="session-btn" data-duration="5" data-type="short_break" onclick="selectSession(this)">
                <span class="session-icon">‚òï</span>
                <span>Short Break</span>
                <span class="session-time">5 min</span>
            </button>
            <button class="session-btn" data-duration="15" data-type="long_break" onclick="selectSession(this)">
                <span class="session-icon">üå¥</span>
                <span>Long Break</span>
                <span class="session-time">15 min</span>
            </button>
        </div>
    </div>
    
    <div class="stats-section">
        <h2>Today's Sessions</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">{{ recent_sessions|length }}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value">{{ recent_sessions|length|multiply:25 }}</div>
                <div class="stat-label">Minutes</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value">{{ recent_sessions|length|divide:4 }}</div>
                <div class="stat-label">Cycles</div>
            </div>
        </div>
    </div>
</div>

<style>
.pomodoro-container {
    max-width: 900px;
    margin: 0 auto;
}

.pomodoro-header {
    text-align: center;
    margin-bottom: 3rem;
}

.pomodoro-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
}

.pomodoro-header p {
    color: var(--text-secondary);
    font-size: 1.1rem;
}

.timer-main {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 3rem;
    margin-bottom: 2rem;
}

.timer-display {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto 3rem;
}

.timer-ring {
    width: 100%;
    height: 100%;
}

.timer-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.time {
    font-size: 4rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    font-family: 'Space Mono', monospace;
    color: var(--text-primary);
}

.session-type {
    color: var(--text-secondary);
    font-size: 1.1rem;
    margin-top: 0.5rem;
    font-weight: 600;
}

.timer-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
}

.control-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.control-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
}

.control-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
}

.control-btn.secondary {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
}

.control-btn.secondary:hover {
    background: var(--bg-secondary);
}

.btn-icon {
    font-size: 1.2rem;
}

.session-selector {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.session-btn {
    background: var(--bg-tertiary);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-primary);
    font-family: inherit;
}

.session-btn:hover {
    background: var(--bg-card);
    border-color: var(--primary);
}

.session-btn.active {
    background: rgba(99, 102, 241, 0.15);
    border-color: var(--primary);
}

.session-icon {
    font-size: 2rem;
}

.session-time {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.stats-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--text-primary);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

@media (max-width: 768px) {
    .timer-main {
        padding: 2rem 1.5rem;
    }
    
    .timer-display {
        width: 250px;
        height: 250px;
    }
    
    .time {
        font-size: 3rem;
    }
    
    .session-selector {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let timerInterval;
let timeLeft = 25 * 60;
let totalTime = 25 * 60;
let isRunning = false;
let currentType = 'focus';

function updateDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('time-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update ring
    const progress = 1 - (timeLeft / totalTime);
    const circumference = 2 * Math.PI * 90;
    const offset = circumference * progress;
    document.getElementById('progress-ring').style.strokeDashoffset = offset;
}

function startTimer() {
    if (!isRunning) {
        isRunning = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('pause-btn').style.display = 'flex';
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateDisplay();
            
            if (timeLeft <= 0) {
                completeSession();
            }
        }, 1000);
    }
}

function pauseTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    document.getElementById('start-btn').style.display = 'flex';
    document.getElementById('pause-btn').style.display = 'none';
}

function resetTimer() {
    pauseTimer();
    timeLeft = totalTime;
    updateDisplay();
}

function selectSession(button) {
    if (isRunning) return;
    
    document.querySelectorAll('.session-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    
    const duration = parseInt(button.dataset.duration);
    currentType = button.dataset.type;
    totalTime = duration * 60;
    timeLeft = totalTime;
    updateDisplay();
    
    const labels = {
        'focus': 'Focus Time',
        'short_break': 'Short Break',
        'long_break': 'Long Break'
    };
    document.getElementById('session-label').textContent = labels[currentType];
}

function completeSession() {
    pauseTimer();
    
    // Save session
    fetch('/pomodoro/start/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_type: currentType,
            duration: totalTime / 60
        })
    });
    
    alert('üéâ Session completed! Great work!');
    resetTimer();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

updateDisplay();
</script>
{% endblock %}
