{% extends 'base.html' %}

{% load math_filters %}

{% block title %}Pomodoro Timer - FlowHub{% endblock %}

{% block content %}
<div class="pomodoro-container">
    <div class="pomodoro-header mb-12 text-center">
        <h1 class="text-4xl font-extrabold mb-2">Focus Timer</h1>
        <p class="text-gray-500">Time doesn't rush here. Stay focused.</p>
    </div>
    
    <div class="timer-main card p-12 mb-8 bg-bg-card/50 backdrop-blur-xl border-white/5">
        <div class="timer-display relative w-[300px] h-[300px] mx-auto mb-12">
            <div class="timer-ring w-full h-full">
                <svg viewBox="0 0 200 200" class="w-full h-full">
                    <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(99, 102, 241, 0.1)" stroke-width="8"/>
                    <circle id="progress-ring" cx="100" cy="100" r="90" fill="none" stroke="url(#gradient)" stroke-width="8" 
                            stroke-linecap="round" transform="rotate(-90 100 100)" 
                            stroke-dasharray="565.48" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear"/>
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            
            <div class="timer-content absolute inset-0 flex flex-col items-center justify-center">
                <div id="time-display" class="time text-6xl font-black font-mono tracking-tighter">25:00</div>
                <div id="session-label" class="session-type text-sm font-bold uppercase tracking-widest text-gray-500 mt-2">Focus Time</div>
            </div>
        </div>
        
        <div class="timer-controls flex justify-center gap-4 mb-12">
            <button id="start-btn" class="btn btn-primary px-10 py-4 rounded-2xl text-lg shadow-2xl shadow-primary/20" onclick="startTimer()">
                {% include "includes/heroicon.html" with icon_name="plus" class="icon-md rotate-[315deg]" %}
                <span>Start</span>
            </button>
            <button id="pause-btn" class="btn btn-primary px-10 py-4 rounded-2xl text-lg" onclick="pauseTimer()" style="display: none;">
                {% include "includes/heroicon.html" with icon_name="minus" class="icon-md rotate-90" %}
                <span>Pause</span>
            </button>
            <button id="reset-btn" class="btn btn-secondary px-8 py-4 rounded-2xl" onclick="resetTimer()">
                {% include "includes/heroicon.html" with icon_name="clock" class="icon-md" %}
                <span>Reset</span>
            </button>
        </div>
        
        <div class="session-selector grid grid-cols-3 gap-4">
            <button class="session-btn active" data-duration="25" data-type="focus" onclick="selectSession(this)">
                <div class="p-3 bg-primary/10 rounded-xl mb-3 text-primary">
                    {% include "includes/heroicon.html" with icon_name="fire" class="icon-lg" %}
                </div>
                <span class="font-bold">Focus</span>
                <span class="text-xs text-gray-500">25 min</span>
            </button>
            <button class="session-btn" data-duration="5" data-type="short_break" onclick="selectSession(this)">
                <div class="p-3 bg-success/10 rounded-xl mb-3 text-success">
                    {% include "includes/heroicon.html" with icon_name="check-circle" class="icon-lg" %}
                </div>
                <span class="font-bold">Short Break</span>
                <span class="text-xs text-gray-500">5 min</span>
            </button>
            <button class="session-btn" data-duration="15" data-type="long_break" onclick="selectSession(this)">
                <div class="p-3 bg-info/10 rounded-xl mb-3 text-info">
                    {% include "includes/heroicon.html" with icon_name="calendar" class="icon-lg" %}
                </div>
                <span class="font-bold">Long Break</span>
                <span class="text-xs text-gray-500">15 min</span>
            </button>
        </div>
    </div>
    
    <div class="stats-section">
        <h2 class="text-2xl font-bold mb-6">Today's Sessions</h2>
        <div class="stats-grid grid grid-cols-3 gap-6">
            <div class="stat-card card text-center p-6">
                <div class="stat-icon text-primary flex justify-center mb-4">
                    {% include "includes/heroicon.html" with icon_name="check-circle" class="icon-xl" %}
                </div>
                <div class="stat-value text-3xl font-black mb-1">{{ recent_sessions|length }}</div>
                <div class="stat-label text-xs uppercase font-bold text-gray-500 tracking-wider">Completed</div>
            </div>
            <div class="stat-card card text-center p-6">
                <div class="stat-icon text-info flex justify-center mb-4">
                    {% include "includes/heroicon.html" with icon_name="clock" class="icon-xl" %}
                </div>
                <div class="stat-value text-3xl font-black mb-1">{{ recent_sessions|length|multiply:25 }}</div>
                <div class="stat-label text-xs uppercase font-bold text-gray-500 tracking-wider">Minutes</div>
            </div>
            <div class="stat-card card text-center p-6">
                <div class="stat-icon text-accent flex justify-center mb-4">
                    {% include "includes/heroicon.html" with icon_name="star" class="icon-xl" %}
                </div>
                <div class="stat-value text-3xl font-black mb-1">{{ recent_sessions|length|divide:4 }}</div>
                <div class="stat-label text-xs uppercase font-bold text-gray-500 tracking-wider">Cycles</div>
            </div>
        </div>
    </div>
</div>

<style>
.pomodoro-container {
    max-width: 800px;
    margin: 0 auto;
}

.session-btn {
    background: var(--bg-tertiary);
    border: 2px solid var(--border);
    border-radius: 20px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.session-btn:hover {
    border-color: var(--primary);
    background: var(--bg-card);
}

.session-btn.active {
    background: rgba(99, 102, 241, 0.05);
    border-color: var(--primary);
}
</style>

<script>
let timerInterval;
let timeLeft = 25 * 60;
let totalTime = 25 * 60;
let isRunning = false;
let currentType = 'focus';

function updateDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('time-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update ring
    const progress = 1 - (timeLeft / totalTime);
    const circumference = 2 * Math.PI * 90;
    const offset = circumference * progress;
    document.getElementById('progress-ring').style.strokeDashoffset = offset;
}

function startTimer() {
    if (!isRunning) {
        isRunning = true;
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('pause-btn').style.display = 'flex';
        
        timerInterval = setInterval(() => {
            timeLeft--;
            updateDisplay();
            
            if (timeLeft <= 0) {
                completeSession();
            }
        }, 1000);
    }
}

function pauseTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    document.getElementById('start-btn').style.display = 'flex';
    document.getElementById('pause-btn').style.display = 'none';
}

function resetTimer() {
    pauseTimer();
    timeLeft = totalTime;
    updateDisplay();
}

function selectSession(button) {
    if (isRunning) return;
    
    document.querySelectorAll('.session-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    
    const duration = parseInt(button.dataset.duration);
    currentType = button.dataset.type;
    totalTime = duration * 60;
    timeLeft = totalTime;
    updateDisplay();
    
    const labels = {
        'focus': 'Focus Time',
        'short_break': 'Short Break',
        'long_break': 'Long Break'
    };
    document.getElementById('session-label').textContent = labels[currentType];
}

function completeSession() {
    pauseTimer();
    
    // Save session
    fetch('/pomodoro/start/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_type: currentType,
            duration: totalTime / 60
        })
    });
    
    alert('Session completed! Great work!');
    resetTimer();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

updateDisplay();
</script>
{% endblock %}
