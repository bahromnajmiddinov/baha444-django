{% extends 'base.html' %}
{% load task_filters %}

{% block title %}Tasks - Kanban View{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Tasks</h1>
        <p class="page-subtitle">Kanban Board</p>
    </div>
    <div class="flex gap-2">
        <a href="?view=list" class="btn btn-secondary">
            {% include "includes/heroicon.html" with icon_name="list-bullet" class="icon-sm" %}
            List
        </a>
        <a href="?view=kanban" class="btn btn-secondary bg-primary/10 text-primary border-primary/50">
            {% include "includes/heroicon.html" with icon_name="square-2-stack" class="icon-sm" %}
            Kanban
        </a>
        <a href="{% url 'task_calendar' %}" class="btn btn-secondary">
            {% include "includes/heroicon.html" with icon_name="calendar" class="icon-sm" %}
            Calendar
        </a>
        <a href="{% url 'task_create' %}" class="btn btn-primary">
            {% include "includes/heroicon.html" with icon_name="plus" class="icon-sm" %}
            New Task
        </a>
    </div>
</div>

<div class="kanban-board">
    <!-- Pitched Column -->
    <div class="kanban-column" data-status="pitched">
        <div class="kanban-header">
            <div class="flex items-center gap-2">
                {% include "includes/heroicon.html" with icon_name="tag" class="icon-sm text-gray-500" %}
                <h3>Pitched</h3>
            </div>
            <span class="kanban-count" id="count-pitched">0</span>
        </div>
        <div class="kanban-cards-container">
            {% for task in tasks %}
                {% if task.status == 'pitched' %}
                    {% include "tasks/partials/kanban_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- In Progress Column -->
    <div class="kanban-column" data-status="in_progress">
        <div class="kanban-header">
            <div class="flex items-center gap-2">
                {% include "includes/heroicon.html" with icon_name="clock" class="icon-sm text-info" %}
                <h3>In Progress</h3>
            </div>
            <span class="kanban-count" id="count-in_progress">0</span>
        </div>
        <div class="kanban-cards-container">
            {% for task in tasks %}
                {% if task.status == 'in_progress' %}
                    {% include "tasks/partials/kanban_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Completed Column -->
    <div class="kanban-column" data-status="completed">
        <div class="kanban-header">
            <div class="flex items-center gap-2">
                {% include "includes/heroicon.html" with icon_name="check-circle" class="icon-sm text-success" %}
                <h3>Completed</h3>
            </div>
            <span class="kanban-count" id="count-completed">0</span>
        </div>
        <div class="kanban-cards-container">
            {% for task in tasks %}
                {% if task.status == 'completed' %}
                    {% include "tasks/partials/kanban_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Paid Column -->
    <div class="kanban-column" data-status="paid">
        <div class="kanban-header">
            <div class="flex items-center gap-2">
                {% include "includes/heroicon.html" with icon_name="currency-dollar" class="icon-sm text-primary" %}
                <h3>Paid</h3>
            </div>
            <span class="kanban-count" id="count-paid">0</span>
        </div>
        <div class="kanban-cards-container">
            {% for task in tasks %}
                {% if task.status == 'paid' %}
                    {% include "tasks/partials/kanban_card.html" with task=task %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<style>
.kanban-board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    height: calc(100vh - 220px);
    min-height: 500px;
}

.kanban-column {
    background: rgba(26, 26, 36, 0.5);
    border: 1px solid var(--border);
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(31, 31, 46, 0.8);
    border-bottom: 1px solid var(--border);
}

.kanban-header h3 {
    font-size: 0.9rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
}

.kanban-count {
    background: var(--bg-primary);
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-muted);
}

.kanban-cards-container {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.kanban-cards-container::-webkit-scrollbar {
    width: 4px;
}

.kanban-column.drag-over {
    background: rgba(99, 102, 241, 0.05);
    border-color: var(--primary);
}
</style>

<script>
function updateCounts() {
    document.querySelectorAll('.kanban-column').forEach(col => {
        const status = col.dataset.status;
        const count = col.querySelectorAll('.kanban-card').length;
        document.getElementById(`count-${status}`).textContent = count;
    });
}

document.addEventListener('DOMContentLoaded', updateCounts);

// Drag and drop functionality
let draggedCard = null;

document.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('kanban-card')) {
        draggedCard = e.target;
        e.target.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
    }
});

document.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('kanban-card')) {
        e.target.style.opacity = '1';
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('drag-over');
        });
    }
});

document.querySelectorAll('.kanban-column').forEach(column => {
    column.addEventListener('dragover', (e) => {
        e.preventDefault();
        column.classList.add('drag-over');
    });

    column.addEventListener('dragleave', () => {
        column.classList.remove('drag-over');
    });

    column.addEventListener('drop', (e) => {
        e.preventDefault();
        column.classList.remove('drag-over');
        
        const taskId = e.dataTransfer.getData('text/plain');
        const newStatus = column.dataset.status;
        
        if (draggedCard) {
            column.querySelector('.kanban-cards-container').appendChild(draggedCard);
            updateCounts();
            
            // Update on server
            fetch(`/tasks/${taskId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status: newStatus })
            });
        }
    });
});
</script>
{% endblock %}
